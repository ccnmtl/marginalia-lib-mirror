<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Marginalia Unit Tests</title>
    <link rel="stylesheet" type="text/css" href="../css/jsUnitStyle.css">
    <script language="JavaScript" type="text/javascript" src="../app/jsUnitCore.js"></script>
	<script type="text/javascript" src="../../marginalia/log.js"></script>
	<script type="text/javascript" src="../../marginalia/html-model.js"></script>
	<script type="text/javascript" src="../../marginalia/domutil.js"></script>
	<script type="text/javascript" src="../../marginalia/ranges.js"></script>
	<script type="text/javascript" src="../../marginalia/range-format.js"></script>
    <script language="javaScript" type="text/javascript">

	
	function testRangeConversion( )
	{
		var rel = document.getElementById( 'word-data' );
	
		var conversionData = [
			{ t: 'p1.1.0;p1.1.1',		s: '/1/1.0;/1/1.1',			q: 'o',				c: 'first character'			},
			{ t: 'p1.1.0;p1.1.3',		s: '/1/1.0;/1/1.3',			q: 'one',			c: 'word alone in block'		},
			{ t: 'p2.1.0;p2.1.5',		s: '/2/1.0;/2/1.3',			q: 'two',			c: 'following space'			},
			{ t: 'p2.1.5;p2.1.10',		s: '/2/2.0;/2/2.5',			q: 'three',			c: 'spaces'						},
			{ t: 'p3.1.0;p3.1.6',		s: '/3/1.0;/3/1.4',			q: 'four',			c: 'spaces at either end'		},
			{ t: 'em1.1.0;em1.1.4',	s: '/3/2.0;/3/2.4',			q: 'five',			c: 'non-breaking element'		},
			{ t: 'p3.1.6;em1.1.4',		s: '/3/2.0;/3/2.4',			q: 'five',			c: 'cross em start boundary'	},
			{ t: 'em1.1.0;p3.3.0',		s: '/3/2.0;/3/2.4',			q: 'five',			c: 'cross em end boundary'		},
			{ t: 'em2.1.0;em3.1.5',	s: '/4/1.0;/4/1.10',		q: 'sevenseven',	c: 'cross em end/start'		},
			{ t: 'p1.1.0;p2.1.4',		s: '/1/1.0;/2/1.3',			q: 'one two',		c: 'span paragraphs'			}
		];
	
		for ( var i = 0;  i < conversionData.length;  ++i )
		{
			var conv = conversionData[ i ];

			conv.textRange = new TextRange( );
			conv.textRange.fromString( conv.t );
			
			conv.sequenceRange = new SequenceRange( );
			conv.sequenceRange.fromString( conv.s );
			
			// TestWord Range -> TextRange conversion
			var wordRange = new WordRange( );			
			wordRange.fromTextRange( conv.textRange, rel, null );
			var sequenceRange = wordRange.toSequenceRange( rel ); 
			assertTrue( 'Convert ' + conv.t + ' to ' + conv.s,
				conv.sequenceRange.equals( sequenceRange ) );
			
			// Test TextRange -> WordRange conversion
			wordRange.fromSequenceRange( conv.sequenceRange, rel, null );
			textRange = new TextRange( );
			textRange.fromWordRange( wordRange );
			var wordRange2 = new WordRange( );
			wordRange2.fromTextRange( conv.textRange, rel, null );
			assertTrue( 'Convert ' + conv.s + ' to ' + conv.t,
				wordRange.equals( wordRange2 ) );
				
			// Test range partition
			var parts = wordRange.partition( );
			var actual = parts.quote.replace( /\s+|\u00a0\s*/g, ' ' );
			var quote = conv.q.replace( /\s+|\u00a0\s*/g, ' ' );
			assertTrue( 'Range ' + conv.s + ' actual quote "' + actual + '" == expected "' + quote + '"', actual == quote );
		}
	}
	
	TextRange.prototype.fromString = function( str )
	{
		var points = str.split( ';' );
		
		// Get the start point
		var parts = points[ 0 ].split( '.' );
		var element = document.getElementById( parts[ 0 ] );
		var childIndex = Number( parts[ 1 ] ) - 1;
		this.startContainer = element.childNodes[ childIndex ];
		this.startOffset = Number( parts[ 2 ] )
		
		// Get the end point
		parts = points[ 1 ].split( '.' );
		element = document.getElementById( parts[ 0 ] );
		childIndex = Number( parts[ 1 ] ) - 1;
		this.endContainer = element.childNodes[ childIndex ];
		this.endOffset = Number( parts[ 2 ] );
	}
    </script>
</head>

<body onload="testRangeConversion()">
<h1>Marginalia Range Format Conversion Tests</h1>

<div id="word-data">
<p id="p1">one</p>
<p id="p2"> two three  </p>
<p id="p3"> four <em id="em1">five</em> six </p>
<p id="p4"> <em id="em2">seven</em><em id="em3">seven</em> </p>
</div>

</body>
</html>
